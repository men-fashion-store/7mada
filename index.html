<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROSSIA - Smart System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- الوضع النهاري --- */
            --bg-main: #fcf9f2;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #3e2723;
            --text-secondary: #795548;
            --accent-color: #6d4c41;
            --price-color: #2e7d32;
            --line-color: #ece0d1;
            --input-bg: #fffbf7;
            --logo-color: #3e2723;
            --card-border: 1px solid rgba(62, 39, 35, 0.1);
            --shadow: 0 4px 15px rgba(62, 39, 35, 0.08);
            
            /* ألوان الخلفية */
            --watermark-color: %233e2723;
            --watermark-opacity: 0.08;
        }

        [data-theme="dark"] {
            /* --- الوضع الليلي --- */
            --bg-main: #000000;
            --card-bg: rgba(18, 18, 18, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #bcaaa4;
            --accent-color: #d7ccc8;
            --price-color: #81c784;
            --line-color: #333333;
            --input-bg: #1e1e1e;
            --logo-color: #ffffff;
            --card-border: 1px solid #333;
            --shadow: 0 4px 15px rgba(255, 255, 255, 0.05);

            --watermark-color: %23ffffff;
            --watermark-opacity: 0.1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s, border-color 0.3s, fill 0.3s; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 20px 20px 100px 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            overflow-x: hidden;

            /* الخلفية الثابتة في المنتصف */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'%3E%3Cg fill='var(--watermark-color)' opacity='var(--watermark-opacity)'%3E%3Ctext x='200' y='200' font-family='serif' font-weight='900' font-size='60' text-anchor='middle' dominant-baseline='middle' transform='rotate(-10 200 200)'%3EROSSIA%3C/text%3E%3Cpath d='M200 50 A 150 150 0 1 0 200 350 A 150 150 0 1 0 200 50 Z M 200 60 A 140 140 0 1 1 200 340 A 140 140 0 1 1 200 60 Z' fill-opacity='0.5'/%3E%3Cpath d='M80 100 Q 100 80 120 100 T 160 100 Q 140 140 100 140 T 80 100' transform='rotate(30 120 120)'/%3E%3Cpath d='M300 280 Q 320 260 340 280 T 380 280 Q 360 320 320 320 T 300 280' transform='rotate(-15 340 300)'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: 500px auto;
        }

        [data-theme="light"] body { --watermark-color: %233e2723; }
        [data-theme="dark"] body { --watermark-color: %23ffffff; }

        /* --- زرار التحويل --- */
        .theme-switch-wrapper { position: absolute; top: 20px; left: 20px; z-index: 100; }
        .theme-switch { display: inline-block; height: 30px; position: relative; width: 55px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--line-color); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; border: 1px solid var(--text-secondary); }
        .slider:before { background-color: var(--text-primary); bottom: 3px; content: ""; height: 22px; left: 4px; position: absolute; transition: .4s; width: 22px; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(24px); background-color: #fff; }
        .slider .icon { position: absolute; top: 50%; transform: translateY(-50%); font-size: 14px; transition: opacity 0.3s; }
        .slider .sun { left: 7px; opacity: 1; color: #f39c12; }
        .slider .moon { right: 7px; opacity: 0; color: #fff; }
        input:checked + .slider .sun { opacity: 0; }
        input:checked + .slider .moon { opacity: 1; }

        /* --- الهيدر --- */
        .header-container { margin-top: 40px; margin-bottom: 30px; text-align: center; animation: fadeIn 1s ease; position: relative; z-index: 2; }
        .logo-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .main-logo-text { font-size: 50px; font-weight: 900; color: var(--text-primary); letter-spacing: -1px; text-transform: uppercase; }
        .cup-icon { width: 45px; height: 45px; fill: var(--logo-color); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .logo-sub { font-size: 13px; font-weight: 700; color: var(--text-secondary); letter-spacing: 4px; margin-top: 5px; }

        /* --- الكروت --- */
        .notebook { width: 100%; max-width: 600px; position: relative; z-index: 2; }
        .person-card {
            background: var(--card-bg); border: var(--card-border);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
            box-shadow: var(--shadow); position: relative;
            backdrop-filter: blur(2px);
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--line-color); padding-bottom: 10px; margin-bottom: 10px; }
        .name-input { border: none; background: transparent; font-size: 18px; font-weight: 800; color: var(--text-primary); width: 100%; outline: none; font-family: 'Cairo'; }
        .name-input::placeholder { color: var(--text-secondary); opacity: 0.5; }
        .delete-btn { background: none; border: 1px solid var(--line-color); color: var(--text-secondary); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .delete-btn:hover { background: #ff5252; color: #fff; border-color: #ff5252; }

        /* --- تصميم صف الطلب (معدل للعداد) --- */
        .item-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .item-input {
            border: 1px solid var(--line-color); background: var(--input-bg);
            color: var(--text-primary); padding: 8px; border-radius: 6px;
            font-family: 'Cairo'; font-size: 14px; outline: none; font-weight: 600; text-align: center;
        }
        .item-input::placeholder { color: var(--text-secondary); opacity: 0.4; font-size: 12px; }
        .item-input:focus { border-color: var(--accent-color); }

        /* تقسيم العواميد */
        .i-qty { width: 15%; font-weight: 800; } /* خانة العدد */
        .i-name { width: 45%; text-align: right; padding-right: 10px; } /* الاسم */
        .i-price { width: 20%; } /* سعر القطعة */
        .i-total { width: 15%; font-size: 14px; font-weight: 900; color: var(--price-color); text-align: center; } /* المجموع */
        
        .i-remove { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; opacity: 0.5; width: 5%; }
        .i-remove:hover { color: #ff5252; opacity: 1; }

        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--line-color); }
        .add-item-btn {
            background: var(--text-primary); color: var(--bg-main); border: none;
            padding: 8px 20px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; font-family: 'Cairo';
        }
        .card-total { font-size: 14px; color: var(--text-secondary); font-weight: 700; }
        .card-total span { color: var(--text-primary); font-size: 18px; font-weight: 900; }

        .main-fab {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 65px; height: 65px; background: var(--text-primary); color: var(--bg-main);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 35px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
            border: 2px solid var(--bg-main); z-index: 90; transition: transform 0.2s;
        }
        .main-fab:hover { transform: translateX(-50%) scale(1.1); }

        .total-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--text-primary); color: var(--bg-main);
            width: 90%; max-width: 400px; padding: 15px 25px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100;
        }
        .total-label { font-size: 12px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .total-val { font-size: 24px; font-weight: 900; }
        .currency { font-size: 12px; color: var(--accent-color); font-weight: bold; }

    </style>
</head>
<body data-theme="light">

    <div class="theme-switch-wrapper">
       <label class="theme-switch">
        <input type="checkbox" id="themeCheckbox" />
        <div class="slider">
            <span class="icon sun">☀</span>
            <span class="icon moon">☾</span>
        </div>
      </label>
    </div>

    <div id="app-content" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        
        <div class="header-container">
            <div class="logo-wrapper">
                <svg class="cup-icon" viewBox="0 0 24 24">
                    <path d="M18.5 3H6c-1.1 0-2 .9-2 2v5.71c0 3.83 2.95 7.18 6.78 7.29 3.96.12 7.22-3.06 7.22-7v-1h.5c1.93 0 3.5-1.57 3.5-3.5S20.43 3 18.5 3zM16 8.99c0 2.8-2.2 5.02-5 5.02s-5-2.21-5-5.02V5h10v3.99zM18.5 8h-.5V5h.5c.83 0 1.5.67 1.5 1.5S19.33 8 18.5 8z" />
                </svg>
                <div class="main-logo-text">ROSSIA</div>
            </div>
            <div class="logo-sub">PREMIUM COFFEE</div>
        </div>

        <div class="notebook">
            <div id="users-container"></div>
        </div>

        <button onclick="addNewUser()" class="main-fab" title="عميل جديد">+</button>

        <div class="total-bar">
            <div>
                <div class="total-label">Grand Total</div>
                <div style="font-size:10px;">الإجمالي الكلي</div>
            </div>
            <div style="display:flex; align-items:baseline; gap:5px;">
                <span id="grand-total" class="total-val">0</span>
                <span class="currency">EGP</span>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBdONnA1oD-7urCeAK99l5i3WVGkit7OK8",
            authDomain: "rossia-eebc7.firebaseapp.com",
            databaseURL: "https://rossia-eebc7-default-rtdb.firebaseio.com",
            projectId: "rossia-eebc7",
            storageBucket: "rossia-eebc7.firebasestorage.app",
            messagingSenderId: "926867373358",
            appId: "1:926867373358:web:7cdad5ea5e5bdfd34b4ebf",
            measurementId: "G-Y09FGPTZ1W"
        };

        let db;
        
        const toggleSwitch = document.getElementById('themeCheckbox');
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.body.setAttribute('data-theme', currentTheme);
            toggleSwitch.checked = currentTheme === 'dark';
        }
        toggleSwitch.addEventListener('change', function(e) {
            const theme = e.target.checked ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });

        window.onload = function() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                // تم التعديل إلى orders_v2 عشان نبدأ نظيف بالهيكلة الجديدة
                db.ref('orders_v2').on('value', renderAll);
            }
        };

        function renderAll(snapshot) {
            const data = snapshot.val();
            const container = document.getElementById('users-container');
            let grandTotal = 0;

            if (!data) {
                container.innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px;'>القائمة فارغة</p>";
                document.getElementById('grand-total').innerText = "0";
                return;
            }

            const existingIds = new Set();
            
            Object.keys(data).forEach(userId => {
                existingIds.add(`card-${userId}`);
                const user = data[userId];
                
                // حساب إجمالي الكارت بناء على الكمية * السعر
                let userTotal = 0;
                if(user.items) {
                    Object.values(user.items).forEach(i => {
                        const qty = Number(i.qty) || 1;
                        const price = Number(i.price) || 0;
                        userTotal += (qty * price);
                    });
                }
                grandTotal += userTotal;

                let card = document.getElementById(`card-${userId}`);
                if (!card) {
                    card = document.createElement('div');
                    card.id = `card-${userId}`;
                    card.className = 'person-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <input type="text" id="name-${userId}" class="name-input" placeholder="اسم العميل.." oninput="updName('${userId}', this.value)">
                            <button class="delete-btn" onclick="delUser('${userId}')">×</button>
                        </div>
                        <div id="items-${userId}"></div>
                        <div class="card-actions">
                            <button class="add-item-btn" onclick="addItem('${userId}')">إضافة +</button>
                            <div class="card-total"><span>${userTotal}</span> ج.م</div>
                        </div>
                    `;
                    container.appendChild(card);
                    if(container.querySelector('p')) container.querySelector('p').remove();
                }

                const nameInp = document.getElementById(`name-${userId}`);
                if(document.activeElement !== nameInp) nameInp.value = user.name || "";
                
                // تحديث رقم الإجمالي في الكارت
                card.querySelector('.card-total span').innerText = userTotal;

                // معالجة الصفوف
                const itemsContainer = document.getElementById(`items-${userId}`);
                const itemsData = user.items || {};
                const currentItemIds = new Set();

                Object.keys(itemsData).forEach(itemId => {
                    currentItemIds.add(`item-${itemId}`);
                    const item = itemsData[itemId];
                    const qtyVal = item.qty || 1;
                    const priceVal = item.price || "";
                    const lineTotal = (Number(qtyVal) * Number(priceVal)) || 0;

                    let row = document.getElementById(`item-${itemId}`);
                    if(!row) {
                        row = document.createElement('div');
                        row.id = `item-${itemId}`;
                        row.className = 'item-row';
                        row.innerHTML = `
                            <input type="number" class="item-input i-qty" id="q-${itemId}" value="${qtyVal}" oninput="updItem('${userId}','${itemId}')">
                            <input class="item-input i-name" id="n-${itemId}" placeholder="الطلب" oninput="updItem('${userId}','${itemId}')">
                            <input type="number" class="item-input i-price" id="p-${itemId}" placeholder="سعر" oninput="updItem('${userId}','${itemId}')">
                            <div class="i-total" id="t-${itemId}">${lineTotal}</div>
                            <button class="i-remove" onclick="delItem('${userId}','${itemId}')">×</button>
                        `;
                        itemsContainer.appendChild(row);
                    }
                    
                    const qInp = document.getElementById(`q-${itemId}`);
                    const nInp = document.getElementById(`n-${itemId}`);
                    const pInp = document.getElementById(`p-${itemId}`);
                    const tDiv = document.getElementById(`t-${itemId}`);

                    if(document.activeElement !== qInp) qInp.value = qtyVal;
                    if(document.activeElement !== nInp) nInp.value = item.text || "";
                    if(document.activeElement !== pInp) pInp.value = priceVal;
                    
                    // تحديث المجموع الفرعي فورياً
                    tDiv.innerText = lineTotal;
                });

                Array.from(itemsContainer.children).forEach(child => {
                    if(!currentItemIds.has(child.id)) child.remove();
                });
            });

            Array.from(container.children).forEach(child => {
                if(child.className === 'person-card' && !existingIds.has(child.id)) child.remove();
            });

            const totalEl = document.getElementById("grand-total");
            const currentDisplay = parseInt(totalEl.innerText);
            if(currentDisplay !== grandTotal) totalEl.innerText = grandTotal;
        }

        // Firebase Functions (Updated for orders_v2)
        const updName = (uid, val) => db.ref(`orders_v2/${uid}`).update({name: val});
        const addNewUser = () => db.ref('orders_v2').push().set({name:"", items:{}});
        const delUser = (uid) => confirm("حذف؟") ? db.ref(`orders_v2/${uid}`).remove() : null;
        
        // إضافة طلب جديد (العدد الافتراضي 1)
        const addItem = (uid) => db.ref(`orders_v2/${uid}/items`).push().set({qty:1, text:"", price:""});
        
        const delItem = (uid, iid) => db.ref(`orders_v2/${uid}/items/${iid}`).remove();
        
        // تحديث البيانات (العدد - الاسم - السعر)
        const updItem = (uid, iid) => {
            const qty = document.getElementById(`q-${iid}`).value;
            const text = document.getElementById(`n-${iid}`).value;
            const price = document.getElementById(`p-${iid}`).value;
            
            db.ref(`orders_v2/${uid}/items/${iid}`).update({
                qty: Number(qty),
                text: text,
                price: Number(price)
            });
        };
    </script>
</body>
</html>
