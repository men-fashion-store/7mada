<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROSSIA - Coffee System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- الوضع النهاري (ألوان القهوة والكراميل) --- */
            --bg-main: #fcf9f2;         /* كريمي فاتح */
            --card-bg: #ffffff;
            --text-primary: #3e2723;    /* بني غامق جداً (لون البن) */
            --text-secondary: #795548;  /* بني فاتح */
            --accent-color: #6d4c41;    /* بني متوسط */
            --price-color: #2e7d32;     /* أخضر للاسعار */
            --line-color: #ece0d1;      /* فواصل بيج */
            --input-bg: #fffbf7;
            --logo-color: #3e2723;      /* لون حباية البن */
            --card-border: 1px solid rgba(62, 39, 35, 0.1);
            --shadow: 0 4px 15px rgba(62, 39, 35, 0.08);
            
            /* خلفية باترن النهار (بني خفيف جداً) */
            --pattern-opacity: 0.06;
            --pattern-color: %233e2723; /* كود اللون البني للـ SVG */
        }

        [data-theme="dark"] {
            /* --- الوضع الليلي (أبيض وأسود وبني فخم) --- */
            --bg-main: #000000;         /* أسود صريح */
            --card-bg: #121212;         /* أسود رمادي للكروت */
            --text-primary: #ffffff;    /* أبيض ناصع */
            --text-secondary: #bcaaa4;  /* بني رمادي فاتح */
            --accent-color: #d7ccc8;    /* أوف وايت */
            --price-color: #81c784;     /* أخضر فاتح */
            --line-color: #333333;      /* فواصل غامقة */
            --input-bg: #1e1e1e;
            --logo-color: #ffffff;      /* اللوجو أبيض في الليل */
            --card-border: 1px solid #333;
            --shadow: 0 4px 15px rgba(255, 255, 255, 0.05);

            /* خلفية باترن الليل (أبيض خفيف) */
            --pattern-opacity: 0.08;
            --pattern-color: %23ffffff; /* كود اللون الأبيض للـ SVG */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s, border-color 0.3s, fill 0.3s; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 20px 20px 100px 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            overflow-x: hidden;

            /* --- الخلفية الجامدة (ROSSIA + حبوب بن + آثار كوباية) --- */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'%3E%3Cg fill='var(--pattern-color)' opacity='var(--pattern-opacity)'%3E%3C!-- Brand Name --%3E%3Ctext x='150' y='150' font-family='serif' font-weight='900' font-size='40' text-anchor='middle' transform='rotate(-15 150 150)'%3EROSSIA%3C/text%3E%3C!-- Coffee Ring Stain --%3E%3Cpath d='M250 50 A 40 40 0 1 0 250 130 A 40 40 0 1 0 250 50 Z M 250 55 A 35 35 0 1 1 250 125 A 35 35 0 1 1 250 55 Z' fill-opacity='0.5'/%3E%3C!-- Coffee Bean 1 --%3E%3Cpath d='M50 200 Q 70 180 90 200 T 130 200 Q 110 240 70 240 T 50 200 M 70 205 Q 90 195 110 205' stroke='var(--pattern-color)' stroke-width='2' fill='none' transform='rotate(30 90 220)'/%3E%3C!-- Coffee Bean 2 (Small) --%3E%3Cpath d='M200 250 Q 210 240 220 250 T 240 250 Q 230 270 210 270 T 200 250' stroke='var(--pattern-color)' stroke-width='2' fill='none' transform='rotate(-45 220 260)'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* تعديل الألوان داخل الـ SVG عبر الـ CSS مباشرة */
        [data-theme="light"] body { --pattern-color: %233e2723; }
        [data-theme="dark"] body { --pattern-color: %23ffffff; }

        /* --- زرار التحويل (شمس وقمر) --- */
        .theme-switch-wrapper { position: absolute; top: 20px; left: 20px; z-index: 100; }
        .theme-switch { display: inline-block; height: 30px; position: relative; width: 55px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--line-color); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; border: 1px solid var(--text-secondary); }
        .slider:before { background-color: var(--text-primary); bottom: 3px; content: ""; height: 22px; left: 4px; position: absolute; transition: .4s; width: 22px; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(24px); background-color: #fff; }
        .slider .icon { position: absolute; top: 50%; transform: translateY(-50%); font-size: 14px; transition: opacity 0.3s; }
        .slider .sun { left: 7px; opacity: 1; color: #f39c12; }
        .slider .moon { right: 7px; opacity: 0; color: #fff; }
        input:checked + .slider .sun { opacity: 0; }
        input:checked + .slider .moon { opacity: 1; }

        /* --- الهيدر --- */
        .header-container { margin-top: 40px; margin-bottom: 30px; text-align: center; animation: fadeIn 1s ease; }
        .logo-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .main-logo-text { font-size: 50px; font-weight: 900; color: var(--text-primary); letter-spacing: -1px; text-transform: uppercase; }
        .logo-dot { color: var(--accent-color); font-size: 60px; line-height: 0; }
        .cup-icon { width: 45px; height: 45px; fill: var(--logo-color); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .logo-sub { font-size: 13px; font-weight: 700; color: var(--text-secondary); letter-spacing: 4px; margin-top: 5px; }

        /* --- الكروت --- */
        .notebook { width: 100%; max-width: 600px; position: relative; }
        .person-card {
            background: var(--card-bg); border: var(--card-border);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: var(--shadow); position: relative;
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--line-color); padding-bottom: 15px; margin-bottom: 15px; }
        .name-input { border: none; background: transparent; font-size: 20px; font-weight: 800; color: var(--text-primary); width: 100%; outline: none; font-family: 'Cairo'; }
        .name-input::placeholder { color: var(--text-secondary); opacity: 0.5; }
        .delete-btn { background: none; border: 1px solid var(--line-color); color: var(--text-secondary); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .delete-btn:hover { background: #ff5252; color: #fff; border-color: #ff5252; }

        /* --- الطلبات --- */
        .item-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .item-input {
            border: 1px solid var(--line-color); background: var(--input-bg);
            color: var(--text-primary); padding: 10px; border-radius: 8px;
            font-family: 'Cairo'; font-size: 14px; outline: none; font-weight: 600;
        }
        .item-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
        .item-input:focus { border-color: var(--accent-color); }
        
        .i-name { flex: 2; }
        .i-price { flex: 1; text-align: center; color: var(--price-color); }
        .i-remove { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; opacity: 0.5; }
        .i-remove:hover { color: #ff5252; opacity: 1; }

        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--line-color); }
        .add-item-btn {
            background: var(--text-primary); color: var(--bg-main); border: none;
            padding: 8px 20px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; font-family: 'Cairo';
        }
        .add-item-btn:hover { opacity: 0.9; }
        .card-total { font-size: 14px; color: var(--text-secondary); font-weight: 700; }
        .card-total span { color: var(--text-primary); font-size: 18px; font-weight: 900; }

        /* --- الزر العائم --- */
        .main-fab {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 65px; height: 65px; background: var(--text-primary); color: var(--bg-main);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 35px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
            border: 2px solid var(--bg-main); z-index: 90; transition: transform 0.2s;
        }
        .main-fab:hover { transform: translateX(-50%) scale(1.1); }

        /* --- الفوتر --- */
        .total-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--text-primary); color: var(--bg-main);
            width: 90%; max-width: 400px; padding: 15px 25px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100;
        }
        .total-label { font-size: 12px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .total-val { font-size: 24px; font-weight: 900; }
        .currency { font-size: 12px; color: var(--accent-color); font-weight: bold; }

    </style>
</head>
<body data-theme="light">

    <div class="theme-switch-wrapper">
       <label class="theme-switch">
        <input type="checkbox" id="themeCheckbox" />
        <div class="slider">
            <span class="icon sun">☀</span>
            <span class="icon moon">☾</span>
        </div>
      </label>
    </div>

    <div id="app-content" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        
        <div class="header-container">
            <div class="logo-wrapper">
                <svg class="cup-icon" viewBox="0 0 24 24">
                    <path d="M18.5 3H6c-1.1 0-2 .9-2 2v5.71c0 3.83 2.95 7.18 6.78 7.29 3.96.12 7.22-3.06 7.22-7v-1h.5c1.93 0 3.5-1.57 3.5-3.5S20.43 3 18.5 3zM16 8.99c0 2.8-2.2 5.02-5 5.02s-5-2.21-5-5.02V5h10v3.99zM18.5 8h-.5V5h.5c.83 0 1.5.67 1.5 1.5S19.33 8 18.5 8z" />
                </svg>
                <div class="main-logo-text">ROSSIA</div>
            </div>
            <div class="logo-sub">PREMIUM COFFEE</div>
        </div>

        <div class="notebook">
            <div id="users-container"></div>
        </div>

        <button onclick="addNewUser()" class="main-fab" title="عميل جديد">+</button>

        <div class="total-bar">
            <div>
                <div class="total-label">Grand Total</div>
                <div style="font-size:10px;">الإجمالي الكلي</div>
            </div>
            <div style="display:flex; align-items:baseline; gap:5px;">
                <span id="grand-total" class="total-val">0</span>
                <span class="currency">EGP</span>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBdONnA1oD-7urCeAK99l5i3WVGkit7OK8",
            authDomain: "rossia-eebc7.firebaseapp.com",
            databaseURL: "https://rossia-eebc7-default-rtdb.firebaseio.com",
            projectId: "rossia-eebc7",
            storageBucket: "rossia-eebc7.firebasestorage.app",
            messagingSenderId: "926867373358",
            appId: "1:926867373358:web:7cdad5ea5e5bdfd34b4ebf",
            measurementId: "G-Y09FGPTZ1W"
        };

        let db;
        
        // Theme Logic
        const toggleSwitch = document.getElementById('themeCheckbox');
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.body.setAttribute('data-theme', currentTheme);
            toggleSwitch.checked = currentTheme === 'dark';
        }
        toggleSwitch.addEventListener('change', function(e) {
            const theme = e.target.checked ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });

        window.onload = function() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                db.ref('orders_v1').on('value', renderAll);
            }
        };

        function renderAll(snapshot) {
            const data = snapshot.val();
            const container = document.getElementById('users-container');
            let grandTotal = 0;

            if (!data) {
                container.innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px;'>القائمة فارغة</p>";
                document.getElementById('grand-total').innerText = "0";
                return;
            }

            // Keep existing elements to prevent redraw flicker (simple reconcilation)
            const existingIds = new Set();
            
            Object.keys(data).forEach(userId => {
                existingIds.add(`card-${userId}`);
                const user = data[userId];
                let userTotal = 0;
                if(user.items) Object.values(user.items).forEach(i => userTotal += Number(i.price) || 0);
                grandTotal += userTotal;

                let card = document.getElementById(`card-${userId}`);
                if (!card) {
                    card = document.createElement('div');
                    card.id = `card-${userId}`;
                    card.className = 'person-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <input type="text" id="name-${userId}" class="name-input" placeholder="اسم العميل.." oninput="updName('${userId}', this.value)">
                            <button class="delete-btn" onclick="delUser('${userId}')">×</button>
                        </div>
                        <div id="items-${userId}"></div>
                        <div class="card-actions">
                            <button class="add-item-btn" onclick="addItem('${userId}')">إضافة +</button>
                            <div class="card-total"><span>${userTotal}</span> ج.م</div>
                        </div>
                    `;
                    container.appendChild(card);
                    // Remove placeholder if exists
                    if(container.querySelector('p')) container.querySelector('p').remove();
                }

                // Update Name
                const nameInp = document.getElementById(`name-${userId}`);
                if(document.activeElement !== nameInp) nameInp.value = user.name || "";
                
                // Update Total Text
                card.querySelector('.card-total span').innerText = userTotal;

                // Handle Items
                const itemsContainer = document.getElementById(`items-${userId}`);
                const itemsData = user.items || {};
                const currentItemIds = new Set();

                Object.keys(itemsData).forEach(itemId => {
                    currentItemIds.add(`item-${itemId}`);
                    const item = itemsData[itemId];
                    let row = document.getElementById(`item-${itemId}`);
                    if(!row) {
                        row = document.createElement('div');
                        row.id = `item-${itemId}`;
                        row.className = 'item-row';
                        row.innerHTML = `
                            <input class="item-input i-name" id="n-${itemId}" placeholder="الطلب" oninput="updItem('${userId}','${itemId}')">
                            <input type="number" class="item-input i-price" id="p-${itemId}" placeholder="0" oninput="updItem('${userId}','${itemId}')">
                            <button class="i-remove" onclick="delItem('${userId}','${itemId}')">×</button>
                        `;
                        itemsContainer.appendChild(row);
                    }
                    const nInp = document.getElementById(`n-${itemId}`);
                    const pInp = document.getElementById(`p-${itemId}`);
                    if(document.activeElement !== nInp) nInp.value = item.text || "";
                    if(document.activeElement !== pInp) pInp.value = item.price || "";
                });

                // Clean deleted items
                Array.from(itemsContainer.children).forEach(child => {
                    if(!currentItemIds.has(child.id)) child.remove();
                });
            });

            // Clean deleted users
            Array.from(container.children).forEach(child => {
                if(child.className === 'person-card' && !existingIds.has(child.id)) child.remove();
            });

            // Animate Total
            const totalEl = document.getElementById("grand-total");
            const currentDisplay = parseInt(totalEl.innerText);
            if(currentDisplay !== grandTotal) totalEl.innerText = grandTotal;
        }

        // Firebase Functions
        const updName = (uid, val) => db.ref(`orders_v1/${uid}`).update({name: val});
        const addNewUser = () => db.ref('orders_v1').push().set({name:"", items:{}});
        const delUser = (uid) => confirm("حذف؟") ? db.ref(`orders_v1/${uid}`).remove() : null;
        const addItem = (uid) => db.ref(`orders_v1/${uid}/items`).push().set({text:"", price:""});
        const delItem = (uid, iid) => db.ref(`orders_v1/${uid}/items/${iid}`).remove();
        const updItem = (uid, iid) => {
            db.ref(`orders_v1/${uid}/items/${iid}`).update({
                text: document.getElementById(`n-${iid}`).value,
                price: Number(document.getElementById(`p-${iid}`).value)
            });
        };
    </script>
</body>
</html>
